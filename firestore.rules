rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwnerEmail() {
      return isSignedIn()
        && request.auth.token.email != null
        && (
          request.auth.token.email == 'me@damiennichols.com'
          || request.auth.token.email == 'damienlovemusic@gmail.com'
        );
    }

    function isAdmin() {
      return isSignedIn() && (request.auth.token.admin == true || isOwnerEmail());
    }

    function isSelf(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    match /users/{userId} {
      allow read: if isSelf(userId) || isAdmin();
      allow create: if isSelf(userId)
        && (
          (isOwnerEmail()
            && request.resource.data.role == 'admin'
            && request.resource.data.plan == 'pro'
            && request.resource.data.isAdmin == true
            && request.resource.data.isPro == true)
          || (!isOwnerEmail()
            && request.resource.data.role == 'member'
            && request.resource.data.plan == 'free'
            && request.resource.data.isAdmin == false
            && request.resource.data.isPro == false)
        );
      allow update: if isSelf(userId)
        && (
          request.resource.data.diff(resource.data).changedKeys().hasOnly([
            'email',
            'displayName',
            'updatedAt',
            'lastLoginAt'
          ])
          || (isOwnerEmail()
            && request.resource.data.diff(resource.data).changedKeys().hasOnly([
              'email',
              'displayName',
              'updatedAt',
              'lastLoginAt',
              'role',
              'plan',
              'isAdmin',
              'isPro'
            ])
            && request.resource.data.role == 'admin'
            && request.resource.data.plan == 'pro'
            && request.resource.data.isAdmin == true
            && request.resource.data.isPro == true)
        );
      allow write: if isAdmin();
    }
  }
}
